using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.Serialization;
using System.ServiceModel;
using System.Text;

namespace BigExchange.Service
{
    public class ClubcardReward : IClubcardReward
    {

        private InstoreClubcardReward.Business.Booking _bizBooking;
        private InstoreClubcardReward.Business.VoucherCollection _bizVoucherColl;
       
        private void ParseBookingDataToBiz(Booking bookingData)
        {

            //create objects from local business class
            _bizBooking = new InstoreClubcardReward.Business.Booking();

            _bizBooking.BookingId = bookingData.BookingId;
            _bizBooking.StoreId = bookingData.StoreId;
            _bizBooking.UserId = bookingData.UserId;
            _bizBooking.TillId = bookingData.TillId;
            _bizBooking.BookingType = bookingData.BookingType;
            _bizBooking.Clubcard = bookingData.Clubcard;
            _bizBooking.Change = bookingData.Change;
            _bizBooking.PrintNumber = bookingData.PrintNumber;
            _bizBooking.ErrorType = (InstoreClubcardReward.Business.ErrorTypes)bookingData.ErrorType;
            _bizBooking.ReprintReason = bookingData.ReprintReason;
            _bizBooking.TrainingMode = bookingData.TrainingMode;
            _bizBooking.CreateDate = bookingData.CreateDate;
            _bizBooking.Status = bookingData.Status;
            _bizBooking.StatusDate = bookingData.StatusDate;

            //create voucher collection on the booking biz object
            #region Voucher
            foreach (Voucher dataVoucher in bookingData.Vouchers)
            {
                InstoreClubcardReward.Business.Voucher bizVoucher = new InstoreClubcardReward.Business.Voucher();
                bizVoucher.Alpha = dataVoucher.Alpha;
                bizVoucher.Channel = dataVoucher.Channel;
                bizVoucher.Clubcard = dataVoucher.Clubcard;
                bizVoucher.Country = dataVoucher.Country;
                bizVoucher.Ean = dataVoucher.Ean;
                bizVoucher.ExpiryDate = dataVoucher.ExpiryDate;
                bizVoucher.IsUsed = dataVoucher.IsUsed;
                bizVoucher.ResponseClubcard = dataVoucher.ResponseClubcard;
                bizVoucher.ResponseCode = dataVoucher.ResponseCode;
                bizVoucher.ResponseValue = dataVoucher.ResponseValue;
                bizVoucher.Status = (InstoreClubcardReward.Business.VoucherStatus)dataVoucher.Status;
                bizVoucher.StoreNo = dataVoucher.StoreNo;
                bizVoucher.Type = (InstoreClubcardReward.Business.VoucherTypes)dataVoucher.Type;
                bizVoucher.UseDateTime = dataVoucher.UseDateTime;
                bizVoucher.VirtualStore = dataVoucher.VirtualStore;
                bizVoucher.VoucherId = dataVoucher.VoucherId;
                _bizBooking.Vouchers.Add(bizVoucher);
              }
            #endregion


            //create ProductLine collection - which conatins a collection of Tokens
            #region Token

            foreach (ProductLine dataProductLine in bookingData.ProductLines)
            {
                InstoreClubcardReward.Business.ProductLine bizProductLine = new InstoreClubcardReward.Business.ProductLine();
                bizProductLine.ProductLineId = dataProductLine.ProductLineId;
                bizProductLine.ProductNumber = dataProductLine.ProductNumber;

                foreach (Token dataToken in dataProductLine.Tokens)  //null here
                {
                    InstoreClubcardReward.Business.Token bizToken = new InstoreClubcardReward.Business.Token();
                    bizToken.Alpha = dataToken.Alpha;
                    bizToken.CustomerDate = dataToken.CustomerDate;
                    bizToken.EAN = dataToken.EAN;
                    bizToken.EndDate = dataToken.EndDate;
                    bizToken.ProductCode = dataToken.ProductCode;
                    bizToken.ProductLineId = dataToken.ProductLineId;
                    bizToken.ResponseCode = dataToken.ResponseCode;
                    bizToken.SupplierTokenCodeId = dataToken.SupplierTokenCodeId;
                    bizToken.SupplyDate = dataToken.SupplyDate;
                    bizToken.TokenId = dataToken.TokenId;
                    bizToken.TokenValue = dataToken.TokenValue;
                    bizToken.UsedByDate = dataToken.UsedByDate;
                    bizToken.VendorCode = dataToken.VendorCode;
                    bizProductLine.Tokens.Add(bizToken); //add newloy created token to product line collection
                }


                //create product collection on the booking biz object
                //a product has 1 Category object
                #region Product
                InstoreClubcardReward.Business.Product bizProduct = new InstoreClubcardReward.Business.Product();
                foreach (Product dataProduct in bookingData.Products)
                {
                    #region category
                    bizProduct.Category = new InstoreClubcardReward.Business.Category();
                    bizProduct.Category.CategoryId = dataProduct.Category.CategoryId;
                    bizProduct.Category.Description = dataProduct.Category.Description;
                    bizProduct.Category.ImageFilename = dataProduct.Category.ImageFilename;
                    //TODO manage the recurrsion, a catagory has a parent which is also a category
                    //bizProduct.Category.Parent = dataProduct.Category.Parent;
                    bizProduct.Category.TokenValue = dataProduct.Category.TokenValue;
                    #endregion

                    bizProduct.Country = dataProduct.Country;
                    bizProduct.CustomerPrice = dataProduct.CustomerPrice;
                    bizProduct.Description = dataProduct.Description;
                    bizProduct.ImageFilename = dataProduct.ImageFilename;
                    bizProduct.LongDescription = dataProduct.LongDescription;
                    bizProduct.ProductCode = dataProduct.ProductCode;
                    bizProduct.ProductType = (InstoreClubcardReward.Business.ProductType)dataProduct.ProductType;
                    bizProduct.ShortDescription = dataProduct.ShortDescription;
                    bizProduct.TokenDescription = dataProduct.TokenDescription;
                    bizProduct.TokenTermsAndConditions = dataProduct.TokenTermsAndConditions;
                    bizProduct.TokenTitle = dataProduct.TokenTitle;
                    bizProduct.TokenType = (InstoreClubcardReward.Business.TokenType)dataProduct.TokenType;
                    bizProduct.TokenValue = dataProduct.TokenValue;
                    bizProduct.UsedByDate = dataProduct.UsedByDate;
                    bizProduct.ValidUntil = dataProduct.ValidUntil;
                    bizProduct.VendorCode = dataProduct.VendorCode;
                    bizProductLine.Product = bizProduct;
                }
                #endregion
                _bizBooking.ProductLines.Add(bizProductLine);
            }
            #endregion

        }

        private void ParseVoucherDataToBiz(VoucherCollection voucherColl)
        {
            //create objects from local business class
            _bizVoucherColl = new InstoreClubcardReward.Business.VoucherCollection();
            //create voucher collection on the booking biz object
            #region Voucher
            foreach (Voucher dataVoucher in voucherColl)
            {
                InstoreClubcardReward.Business.Voucher bizVoucher = new InstoreClubcardReward.Business.Voucher();
                bizVoucher.Alpha = dataVoucher.Alpha;
                bizVoucher.Channel = dataVoucher.Channel;
                bizVoucher.Clubcard = dataVoucher.Clubcard;
                bizVoucher.Country = dataVoucher.Country;
                bizVoucher.Ean = dataVoucher.Ean;
                bizVoucher.ExpiryDate = dataVoucher.ExpiryDate;
                bizVoucher.IsUsed = dataVoucher.IsUsed;
                bizVoucher.ResponseClubcard = dataVoucher.ResponseClubcard;
                bizVoucher.ResponseCode = dataVoucher.ResponseCode;
                bizVoucher.ResponseValue = dataVoucher.ResponseValue;
                bizVoucher.Status = (InstoreClubcardReward.Business.VoucherStatus)dataVoucher.Status;
                bizVoucher.StoreNo = dataVoucher.StoreNo;
                bizVoucher.Type = (InstoreClubcardReward.Business.VoucherTypes)dataVoucher.Type;
                bizVoucher.UseDateTime = dataVoucher.UseDateTime;
                bizVoucher.VirtualStore = dataVoucher.VirtualStore;
                bizVoucher.VoucherId = dataVoucher.VoucherId;
                _bizVoucherColl.Add(bizVoucher);
            }
            #endregion
        }

        /// <summary>
        /// Returns a collection of products by making a call to the GetProducts() method of InstoreClubcardReward.Business.ProductCollection class
        /// then parses the returned value into an object of BigExchange.ProductCollection and finally returns it.
        /// </summary>
        public ProductCollection GetProducts()
        {
            BigExchange.ProductCollection objBigExProdColl = new ProductCollection(); 
            try
            {
                InstoreClubcardReward.Business.ProductCollection bizProductCollection = InstoreClubcardReward.Business.ProductCollection.GetProductsWCF();
                foreach (InstoreClubcardReward.Business.Product bizProduct in bizProductCollection)
                {
                    BigExchange.Product objBigExProd = new Product();
                    objBigExProd.Description = bizProduct.Description;
                    objBigExProd.StrippedDescription = bizProduct.StrippedDescription; 
                    objBigExProd.ProductCode = bizProduct.ProductCode;
                    objBigExProd.VendorCode = bizProduct.VendorCode;
                    objBigExProd.CustomerPrice = bizProduct.CustomerPrice;
                    objBigExProd.TokenValue = bizProduct.TokenValue;
                    objBigExProd.Country = bizProduct.Country;
                    objBigExProd.ValidUntil = bizProduct.ValidUntil;
                    objBigExProd.UsedByDate = bizProduct.UsedByDate;
                    objBigExProd.ImageFilename = bizProduct.ImageFilename;
                    objBigExProd.ShortDescription = bizProduct.ShortDescription;
                    objBigExProd.LongDescription = bizProduct.LongDescription;
                    objBigExProd.ProductType = (BigExchange.ProductType)bizProduct.ProductType;
                    objBigExProd.TokenType = (BigExchange.TokenType)bizProduct.TokenType;
                    objBigExProd.TokenTitle = bizProduct.TokenTitle;
                    objBigExProd.TokenDescription = bizProduct.TokenDescription;
                    objBigExProd.TokenTermsAndConditions = bizProduct.TokenTermsAndConditions;

                    //Category object
                    objBigExProd.Category = new Category();
                    objBigExProd.Category.CategoryId = bizProduct.Category.CategoryId;
                    objBigExProd.Category.Description = bizProduct.Category.Description;
                    objBigExProd.Category.ImageFilename = bizProduct.Category.ImageFilename;
                    objBigExProd.Category.TokenValue = bizProduct.Category.TokenValue;
                    objBigExProd.Category.Parent = null;

                    objBigExProdColl.Add(objBigExProd);
                }
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:GetProducts()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx,"Exception occured while getting the list of Products");
            }
            return objBigExProdColl; 
        }

        /// <summary>
        /// Returns a collection of categories by making a call to the GetCategories() method of InstoreClubcardReward.Business.CategoryCollection class
        /// then parses the returned value into an object of BigExchange.CategoryCollection and finally returns it.
        /// </summary>
        public CategoryCollection GetCategories()
        {
            BigExchange.CategoryCollection objBigExCategoryColl = new CategoryCollection();
            try
            {
                InstoreClubcardReward.Business.CategoryCollection bizCategoryCollection = InstoreClubcardReward.Business.CategoryCollection.GetCategoriesWCF();
                foreach (InstoreClubcardReward.Business.Category bizCategory in bizCategoryCollection)
                {
                    BigExchange.Category objBigExCategory = new Category();
                    objBigExCategory.CategoryId = bizCategory.CategoryId;
                    objBigExCategory.Description = bizCategory.Description;
                    objBigExCategory.ImageFilename = bizCategory.ImageFilename;
                    objBigExCategory.TokenValue = bizCategory.TokenValue;
                    objBigExCategory.Parent = null;
                    objBigExCategoryColl.Add(objBigExCategory);
                }
                return objBigExCategoryColl;
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:GetCategories()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the list of Categories");
            }    
        }

        /// <summary>
        /// Returns a collection of category collection  by making a call to the GetCategoryIncludes() method of InstoreClubcardReward.Business.GetCategoryIncludesCollection class
        /// then parses the returned value into an object of BigExchange.CategoryIncludesCollection and finally returns it.
        /// </summary>
        public CategoryIncludesCollection GetCategoryIncludes(int categoryId)
        {
            BigExchange.CategoryIncludesCollection objBigExCatIncColl = new CategoryIncludesCollection();
            try
            {
                InstoreClubcardReward.Business.CategoryIncludesCollection bizCatIncCollection = InstoreClubcardReward.Business.CategoryIncludesCollection.GetCategoryIncludesWCF(categoryId);
                foreach (InstoreClubcardReward.Business.CategoryIncludes bizCatInc in bizCatIncCollection)
                {
                    BigExchange.CategoryIncludes objBigExCatInc = new CategoryIncludes();
                    objBigExCatInc.CategoryId = bizCatInc.CategoryId;
                    objBigExCatInc.LineId = bizCatInc.LineId;
                    objBigExCatInc.Description1 = bizCatInc.Description1;
                    objBigExCatInc.Description2 = bizCatInc.Description2;
                    objBigExCatInc.Description3 = bizCatInc.Description3;
                    objBigExCatIncColl.Add(objBigExCatInc);
                }
                return objBigExCatIncColl;
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:CategoryIncludesCollection()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the list of CategoryIncludesCollection");
            }
        }

        /// <summary>
        /// Returns a collection of PrintReasons  by making a call to the GetPrintReasons() method of InstoreClubcardReward.Business.PrintReasonCollection class
        /// then parses the returned value into an object of BigExchange.PrintReasonCollection and finally returns it.
        /// </summary>
        public PrintReasonCollection GetPrintReasons()
        {
            BigExchange.PrintReasonCollection objBigExPrntRsnColl = new PrintReasonCollection();
            try
            {
                InstoreClubcardReward.Business.PrintReasonCollection bizPrntRsnCollection = InstoreClubcardReward.Business.PrintReasonCollection.GetPrintReasonsWCF();
                foreach (InstoreClubcardReward.Business.PrintReason bizPrntRsn in bizPrntRsnCollection)
                {
                    BigExchange.PrintReason objBigExPrntRsn = new PrintReason();
                    objBigExPrntRsn.PrintReasonId = bizPrntRsn.PrintReasonId;
                    objBigExPrntRsn.DisplayOrder = bizPrntRsn.DisplayOrder;
                    objBigExPrntRsn.PrintReasonText = bizPrntRsn.PrintReasonText;
                    objBigExPrntRsn.Enabled = bizPrntRsn.Enabled;
                    objBigExPrntRsnColl.Add(objBigExPrntRsn);
                }
                return objBigExPrntRsnColl;
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:GetPrintReasons()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the list of PrintReasons");
            }
        }

        /// <summary>
        /// Validates the given set of vouchers by making a call to SV webservice
        /// </summary>
        public VoucherCollection ValidateVouchers(VoucherCollection voucherColl, string clubcard, int agentId, string country)
        {
            try
            {
                 ParseVoucherDataToBiz(voucherColl);
                 _bizVoucherColl.ValidateVouchers(clubcard, agentId, country);

                
                 //create objects from local Big Exchange class
                  VoucherCollection objBigExVoucherColl = new VoucherCollection();
                 //update voucher collection 
                 #region Voucher
                 foreach (InstoreClubcardReward.Business.Voucher bizVoucher in _bizVoucherColl)
                 {
                     BigExchange.Voucher objBigExVoucher = new BigExchange.Voucher();

                     objBigExVoucher.Ean = bizVoucher.Ean;
                     objBigExVoucher.Alpha = bizVoucher.Alpha;
                     objBigExVoucher.Clubcard = bizVoucher.Clubcard;
                     objBigExVoucher.Country = bizVoucher.Country;
                     objBigExVoucher.Status = (BigExchange.VoucherStatus)bizVoucher.Status;
                     objBigExVoucher.Type = (BigExchange.VoucherTypes)bizVoucher.Type;
                     objBigExVoucher.StoreNo = bizVoucher.StoreNo;
                     objBigExVoucher.Channel = bizVoucher.Channel;
                     objBigExVoucher.VirtualStore = bizVoucher.VirtualStore;
                     objBigExVoucher.UseDateTime = bizVoucher.UseDateTime;
                     objBigExVoucher.ExpiryDate = bizVoucher.ExpiryDate;
                     objBigExVoucher.ResponseCode = bizVoucher.ResponseCode;
                     objBigExVoucher.ResponseClubcard = bizVoucher.ResponseClubcard;
                     objBigExVoucher.ResponseValue = bizVoucher.ResponseValue;
                     objBigExVoucher.IsUsed = bizVoucher.IsUsed;
                     objBigExVoucher.VoucherId = bizVoucher.VoucherId;
                     //Read Olny property
                     //objBigExVoucher.Value = bizVoucher.Value;
                     objBigExVoucherColl.Add(objBigExVoucher);
                 }
                 #endregion

                 return objBigExVoucherColl;
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:ValidateVouchers()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while validating the voucher list");
            }
        }

        /// <summary>
        /// Validates the given set of vouchers by making a call to SV webservice
        /// </summary>
        //public Boolean ProcessBooking(Booking bookingData,string country)
        public Booking ProcessBooking(Booking bookingData,string country)
        {
            Boolean lbFlag = false;
            try
            {
                ParseBookingDataToBiz(bookingData);
                lbFlag = _bizBooking.ProcessBooking(country);

                if (lbFlag == false)
                {
                    throw new Exception("ProcessBooking Method Returning a False Flag");
                }
                
                BigExchange.Booking objBigExBooking = new BigExchange.Booking();
                //ParseBizToBigExBooking();
                
                objBigExBooking.BookingId = _bizBooking.BookingId;
                objBigExBooking.StoreId = _bizBooking.StoreId;
                objBigExBooking.UserId = _bizBooking.UserId;
                objBigExBooking.TillId = _bizBooking.TillId;
                objBigExBooking.BookingType = _bizBooking.BookingType;

                objBigExBooking.Clubcard = _bizBooking.Clubcard;
                objBigExBooking.Change = _bizBooking.Change;
                objBigExBooking.PrintNumber = _bizBooking.PrintNumber;
                objBigExBooking.ErrorType = (BigExchange.ErrorTypes)_bizBooking.ErrorType;
                objBigExBooking.ReprintReason = _bizBooking.ReprintReason;
                //objBigExBooking.ErrorDescription = _bizBooking.ErrorDescription;  //read only property
                objBigExBooking.TrainingMode = _bizBooking.TrainingMode;

                objBigExBooking.CreateDate = _bizBooking.CreateDate;
                objBigExBooking.Status = _bizBooking.Status;
                objBigExBooking.StatusDate = _bizBooking.StatusDate;
                //objBigExBooking.StatusDescription = _bizBooking.StatusDescription;  //read only property

                //create voucher collection on the booking biz object
                #region Voucher
                foreach (InstoreClubcardReward.Business.Voucher bizVoucher in _bizBooking.Vouchers)
                {
                    BigExchange.Voucher objBigExVoucher = new BigExchange.Voucher();

                    objBigExVoucher.Ean = bizVoucher.Ean;
                    objBigExVoucher.Alpha = bizVoucher.Alpha;
                    objBigExVoucher.Clubcard = bizVoucher.Clubcard;
                    objBigExVoucher.Country = bizVoucher.Country;
                    objBigExVoucher.Status = (BigExchange.VoucherStatus)bizVoucher.Status;
                    objBigExVoucher.Type = (BigExchange.VoucherTypes)bizVoucher.Type;
                    objBigExVoucher.StoreNo = bizVoucher.StoreNo;
                    objBigExVoucher.Channel = bizVoucher.Channel;
                    objBigExVoucher.VirtualStore = bizVoucher.VirtualStore;
                    objBigExVoucher.UseDateTime = bizVoucher.UseDateTime;
                    objBigExVoucher.ExpiryDate = bizVoucher.ExpiryDate;
                    objBigExVoucher.ResponseCode = bizVoucher.ResponseCode;
                    objBigExVoucher.ResponseClubcard = bizVoucher.ResponseClubcard;
                    objBigExVoucher.ResponseValue = bizVoucher.ResponseValue;
                    objBigExVoucher.IsUsed = bizVoucher.IsUsed;
                    objBigExVoucher.VoucherId = bizVoucher.VoucherId;
                    //Read Olny property
                    //objBigExVoucher.Value = bizVoucher.Value;
                    objBigExBooking.Vouchers.Add(objBigExVoucher);
                }
                #endregion

                //create ProductLine collection - which conatins a collection of Tokens
                #region Token

                foreach (InstoreClubcardReward.Business.ProductLine bizProdLine in _bizBooking.ProductLines)
                {
                    //InstoreClubcardReward.Business.ProductLine bizProductLine = new InstoreClubcardReward.Business.ProductLine();
                    BigExchange.ProductLine objBigExProdLine = new BigExchange.ProductLine();
                    objBigExProdLine.ProductLineId = bizProdLine.ProductLineId;
                    objBigExProdLine.ProductNumber = bizProdLine.ProductNumber;

                    objBigExProdLine.Product = new BigExchange.Product();
                    objBigExProdLine.Product.Description = bizProdLine.Product.Description;
                    objBigExProdLine.Product.StrippedDescription = bizProdLine.Product.StrippedDescription;
                    objBigExProdLine.Product.ProductCode = bizProdLine.Product.ProductCode;
                    objBigExProdLine.Product.VendorCode = bizProdLine.Product.VendorCode;
                    objBigExProdLine.Product.CustomerPrice = bizProdLine.Product.CustomerPrice;
                    objBigExProdLine.Product.TokenValue = bizProdLine.Product.TokenValue;
                    objBigExProdLine.Product.Country = bizProdLine.Product.Country;
                    objBigExProdLine.Product.ValidUntil = bizProdLine.Product.ValidUntil;
                    objBigExProdLine.Product.UsedByDate = bizProdLine.Product.UsedByDate;
                    objBigExProdLine.Product.ImageFilename = bizProdLine.Product.ImageFilename;
                    objBigExProdLine.Product.ShortDescription = bizProdLine.Product.ShortDescription;
                    objBigExProdLine.Product.LongDescription = bizProdLine.Product.LongDescription;
                    objBigExProdLine.Product.ProductType = (BigExchange.ProductType)bizProdLine.Product.ProductType;
                    objBigExProdLine.Product.TokenType = (BigExchange.TokenType)bizProdLine.Product.TokenType;
                    objBigExProdLine.Product.TokenTitle = bizProdLine.Product.TokenTitle;
                    objBigExProdLine.Product.TokenDescription = bizProdLine.Product.TokenDescription;
                    objBigExProdLine.Product.TokenTermsAndConditions = bizProdLine.Product.TokenTermsAndConditions;

                    //Category object
                    objBigExProdLine.Product.Category = new Category();
                    objBigExProdLine.Product.Category.CategoryId = bizProdLine.Product.Category.CategoryId;
                    objBigExProdLine.Product.Category.Description = bizProdLine.Product.Category.Description;
                    objBigExProdLine.Product.Category.ImageFilename = bizProdLine.Product.Category.ImageFilename;
                    objBigExProdLine.Product.Category.TokenValue = bizProdLine.Product.Category.TokenValue;
                    objBigExProdLine.Product.Category.Parent = null;

                    //objBigExBooking.Products.Add(objBigExProd);


                    foreach (InstoreClubcardReward.Business.Token bizToken in bizProdLine.Tokens)  //null here
                    {
                        //InstoreClubcardReward.Business.Token bizToken = new InstoreClubcardReward.Business.Token();
                        BigExchange.Token objBigExToken = new BigExchange.Token();

                        objBigExToken.TokenValue = bizToken.TokenValue;
                        objBigExToken.EAN = bizToken.EAN;
                        objBigExToken.Alpha = bizToken.Alpha;
                        objBigExToken.ProductCode = bizToken.ProductCode;
                        objBigExToken.UsedByDate = bizToken.UsedByDate;
                        objBigExToken.VendorCode = bizToken.VendorCode;
                        objBigExToken.SupplyDate = bizToken.SupplyDate;
                        objBigExToken.ProductLineId = bizToken.ProductLineId;
                        objBigExToken.TokenId = bizToken.TokenId;
                        objBigExToken.ResponseCode = bizToken.ResponseCode;
                        objBigExToken.SupplierTokenCodeId = bizToken.SupplierTokenCodeId;
                        objBigExToken.CustomerDate = bizToken.CustomerDate;
                        objBigExToken.EndDate = bizToken.EndDate;
                        objBigExProdLine.Tokens.Add(objBigExToken); //add newloy created token to product line collection
                    }
                    objBigExBooking.ProductLines.Add(objBigExProdLine);
                }
                #endregion

                return objBigExBooking;
               
                // return lbFlag;
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:ProcessBooking()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while processing the booking details");
            }
        }

        /// <summary>
        /// Saves to BookingError table. On save with a booking 
        /// </summary>
        /// <param name="bookingData"></param>
        /// <param name="error"></param>
        public void SaveToBookingError(Booking bookingData, string error)
        {
            try
            {
                //ParseDataToBiz(bookingData);
                _bizBooking = new InstoreClubcardReward.Business.Booking();
                _bizBooking.BookingId = bookingData.BookingId;
                _bizBooking.SaveToBookingError(error);

            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:SaveToBookingError()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while storing errors to BookingError");
            }
        }
        
        /// <summary>
        /// Saves to Training table. Saves text with
        /// current user id. Used to audit training.000111
        /// </summary>
        /// <param name="locationDescription"></param>
        /// <param name="storeId"></param>
        /// <param name="tillId"></param>
        /// <param name="userId"></param>
        /// <param name="bookingId"></param>
        public void SaveToTraining(string locationDescription, int storeId, int tillId, int userId, int bookingId)
        {
            try
            {
                InstoreClubcardReward.Business.Booking.SaveToTraining(locationDescription, storeId, tillId, userId, bookingId);
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:SaveToTraining()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while storing data into Training table");
            }

        }

        /// <summary>
        /// Gets the bookings for clubcard.
        /// </summary>
        /// <param name="clubcard"></param>
        /// <param name="startDate"></param>
        /// <param name="endDate"></param>
        /// <param name="userId"></param>
        /// <returns></returns>
        public List<Booking> GetBookingsForClubcard(string clubcard, DateTime startDate, DateTime endDate, int userId)
        {

            List<Booking> objBigExBookingColl = new List<Booking>();

            try
            {

                List<InstoreClubcardReward.Business.Booking> bizBookingCollection = InstoreClubcardReward.Business.Booking.GetBookingsForClubcardWCF(clubcard, startDate, endDate, userId);

                foreach (InstoreClubcardReward.Business.Booking bizBooking in bizBookingCollection)
                {
                    BigExchange.Booking objBigExBooking = new BigExchange.Booking();
                    objBigExBooking.BookingId = bizBooking.BookingId;
                    objBigExBooking.StoreId = bizBooking.StoreId;
                    objBigExBooking.UserId = bizBooking.UserId;
                    objBigExBooking.TillId = bizBooking.TillId;
                    objBigExBooking.BookingType = _bizBooking.BookingType;

                    objBigExBooking.Clubcard = bizBooking.Clubcard;
                    objBigExBooking.Change = _bizBooking.Change;
                    objBigExBooking.PrintNumber = bizBooking.PrintNumber;
                    objBigExBooking.ErrorType = (BigExchange.ErrorTypes)bizBooking.ErrorType;
                    objBigExBooking.ReprintReason = bizBooking.ReprintReason;
                    //objBigExBooking.ErrorDescription = bizBooking.ErrorDescription;  //read only property
                    objBigExBooking.TrainingMode = bizBooking.TrainingMode;

                    objBigExBooking.CreateDate = bizBooking.CreateDate;
                    objBigExBooking.Status = bizBooking.Status;
                    objBigExBooking.StatusDate = bizBooking.StatusDate;
                    //objBigExBooking.StatusDescription = _bizBooking.StatusDescription;  //read only property


                    //create voucher collection on the booking biz object
                    #region Voucher
                    foreach (InstoreClubcardReward.Business.Voucher bizVoucher in bizBooking.Vouchers)
                    {
                        BigExchange.Voucher objBigExVoucher = new BigExchange.Voucher();

                        objBigExVoucher.Ean = bizVoucher.Ean;
                        objBigExVoucher.Alpha = bizVoucher.Alpha;
                        objBigExVoucher.Clubcard = bizVoucher.Clubcard;
                        objBigExVoucher.Country = bizVoucher.Country;
                        objBigExVoucher.Status = (BigExchange.VoucherStatus)bizVoucher.Status;
                        objBigExVoucher.Type = (BigExchange.VoucherTypes)bizVoucher.Type;
                        objBigExVoucher.StoreNo = bizVoucher.StoreNo;
                        objBigExVoucher.Channel = bizVoucher.Channel;
                        objBigExVoucher.VirtualStore = bizVoucher.VirtualStore;
                        objBigExVoucher.UseDateTime = bizVoucher.UseDateTime;
                        objBigExVoucher.ExpiryDate = bizVoucher.ExpiryDate;
                        objBigExVoucher.ResponseCode = bizVoucher.ResponseCode;
                        objBigExVoucher.ResponseClubcard = bizVoucher.ResponseClubcard;
                        objBigExVoucher.ResponseValue = bizVoucher.ResponseValue;
                        objBigExVoucher.IsUsed = bizVoucher.IsUsed;
                        objBigExVoucher.VoucherId = bizVoucher.VoucherId;
                        //Read Olny property
                        //objBigExVoucher.Value = bizVoucher.Value;
                        objBigExBooking.Vouchers.Add(objBigExVoucher);
                    }
                    #endregion

                    //create ProductLine collection - which conatins a collection of Tokens
                    #region Token

                    foreach (InstoreClubcardReward.Business.ProductLine bizProdLine in bizBooking.ProductLines)
                    {
                        //InstoreClubcardReward.Business.ProductLine bizProductLine = new InstoreClubcardReward.Business.ProductLine();
                        BigExchange.ProductLine objBigExProdLine = new BigExchange.ProductLine();
                        objBigExProdLine.ProductLineId = bizProdLine.ProductLineId;
                        objBigExProdLine.ProductNumber = bizProdLine.ProductNumber;

                        objBigExProdLine.Product = new BigExchange.Product();
                        objBigExProdLine.Product.Description = bizProdLine.Product.Description;
                        objBigExProdLine.Product.StrippedDescription = bizProdLine.Product.StrippedDescription;
                        objBigExProdLine.Product.ProductCode = bizProdLine.Product.ProductCode;
                        objBigExProdLine.Product.VendorCode = bizProdLine.Product.VendorCode;
                        objBigExProdLine.Product.CustomerPrice = bizProdLine.Product.CustomerPrice;
                        objBigExProdLine.Product.TokenValue = bizProdLine.Product.TokenValue;
                        objBigExProdLine.Product.Country = bizProdLine.Product.Country;
                        objBigExProdLine.Product.ValidUntil = bizProdLine.Product.ValidUntil;
                        objBigExProdLine.Product.UsedByDate = bizProdLine.Product.UsedByDate;
                        objBigExProdLine.Product.ImageFilename = bizProdLine.Product.ImageFilename;
                        objBigExProdLine.Product.ShortDescription = bizProdLine.Product.ShortDescription;
                        objBigExProdLine.Product.LongDescription = bizProdLine.Product.LongDescription;
                        objBigExProdLine.Product.ProductType = (BigExchange.ProductType)bizProdLine.Product.ProductType;
                        objBigExProdLine.Product.TokenType = (BigExchange.TokenType)bizProdLine.Product.TokenType;
                        objBigExProdLine.Product.TokenTitle = bizProdLine.Product.TokenTitle;
                        objBigExProdLine.Product.TokenDescription = bizProdLine.Product.TokenDescription;
                        objBigExProdLine.Product.TokenTermsAndConditions = bizProdLine.Product.TokenTermsAndConditions;

                        //Category object
                        objBigExProdLine.Product.Category = new Category();
                        objBigExProdLine.Product.Category.CategoryId = bizProdLine.Product.Category.CategoryId;
                        objBigExProdLine.Product.Category.Description = bizProdLine.Product.Category.Description;
                        objBigExProdLine.Product.Category.ImageFilename = bizProdLine.Product.Category.ImageFilename;
                        objBigExProdLine.Product.Category.TokenValue = bizProdLine.Product.Category.TokenValue;
                        objBigExProdLine.Product.Category.Parent = null;

                        //objBigExBooking.Products.Add(objBigExProd);


                        foreach (InstoreClubcardReward.Business.Token bizToken in bizProdLine.Tokens)  //null here
                        {
                            //InstoreClubcardReward.Business.Token bizToken = new InstoreClubcardReward.Business.Token();
                            BigExchange.Token objBigExToken = new BigExchange.Token();

                            objBigExToken.Alpha = bizToken.Alpha;
                            objBigExToken.CustomerDate = bizToken.CustomerDate;
                            objBigExToken.EAN = bizToken.EAN;
                            objBigExToken.EndDate = bizToken.EndDate;
                            objBigExToken.ProductCode = bizToken.ProductCode;
                            objBigExToken.ProductLineId = bizToken.ProductLineId;
                            objBigExToken.ResponseCode = bizToken.ResponseCode;
                            objBigExToken.SupplierTokenCodeId = bizToken.SupplierTokenCodeId;
                            objBigExToken.SupplyDate = bizToken.SupplyDate;
                            objBigExToken.TokenId = bizToken.TokenId;
                            objBigExToken.TokenValue = bizToken.TokenValue;
                            objBigExToken.UsedByDate = bizToken.UsedByDate;
                            objBigExToken.VendorCode = bizToken.VendorCode;
                            objBigExProdLine.Tokens.Add(objBigExToken); //add newloy created token to product line collection
                        }
                        objBigExBooking.ProductLines.Add(objBigExProdLine);
                    }
                    #endregion

                    objBigExBookingColl.Add(objBigExBooking);
                }

                return objBigExBookingColl;
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:GetBookingsForClubcard()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the list of Bookings For Clubcard");
            }
            
        }

        /// <summary>
        /// Gets the reprint till token script.
        /// </summary>
        /// <param name="bookingData"></param>
        /// <param name="bookingId"></param>
        /// <param name="reprintReason"></param>
        /// <returns></returns>
        public string GetReprintTillTokenScript(Booking bookingData, int bookingId, int? reprintReason)
        {
            try
            {
                ParseBookingDataToBiz(bookingData);
                _bizBooking.BookingId = bookingId;
                return _bizBooking.GetReprintTillTokenScriptWCF(_bizBooking.BookingId, reprintReason);
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:GetReprintTillTokenScript()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the Reprint TokenScript");
            }
        }

        /// <summary>
        /// Gets the till coupon script.
        /// </summary>
        /// <param name="bookingData"></param>
        /// <param name="reprintReason"></param>
        /// <returns></returns>
        public string GetTillTokenScript(Booking bookingData, int? reprintReason)
        {
            try
            {
                ParseBookingDataToBiz(bookingData);
                _bizBooking.Products = InstoreClubcardReward.Business.ProductCollection.GetProductsWCF();
                return _bizBooking.GetTillTokenScriptWCF(reprintReason);
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:GetTillTokenScript()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the Till TokenScript");
            }
        }

        


        /// <summary>
        /// from the IP address get the parameters for the entry page
        /// returns an empty string if not in Kiosk table
        /// </summary>
        /// <param name="clientIP"></param>
        /// <returns></returns>
        public string KioskEntryPage(string clientIP)
        {
            try
            {
                return InstoreClubcardReward.Business.Kiosk.KioskEntryPageWCF(clientIP);
            }
            catch (Exception ex)
            {
                CustomException objCustEx = new CustomException();
                objCustEx.StatusCode = "Error in Funtion:KioskEntryPage()";
                objCustEx.ErrorMessage = ex.Message;
                throw new FaultException<CustomException>(objCustEx, "Exception occured while getting the URL parameters for the entry page");
            }
        }
    }
}
