# APIServices Overview
APIGateway is the intermediary thin layer that acts as a reverse proxy for backend services.
# How do we use the API
## Registration
To use the APIGateway services, you need to register your product. To register your product, please get in touch with the APIGateway administration team whose contacts** have been shared in the Appendix section below. Post registration, a set of 2 keys would be shared. These keys are going to be referred to as appkey and private key going forward. The appkey must be passed along in each request to the API. However, the private key must be kept secured and never passed over the wire. Any leakage of the private key should be considered a severe breach of security.
The keys must be refreshed if any such breach gets reported. To consume the gateway service, a POST request must be made in the format described below.
## API Gateway Request
### Sample POST Request
**Headers:**
```
  appkey:"",
  accesstoken:"",
  uuid:"",
  timestamp:"",
  nonce:"",
  signature:"",
  X-TransactionID:""
```
**Body:**
```
{ "service":"clubcardservice", operation":"GetChristmasSaverSummary",
"parameters":
[ {"Key":"samplekey","Value":"samplevalue"},
  {"Key":"culture","Value":"en-GB"}
]}
```
### Headers Explained
|field|explanation|
|-----|:----------:|
|appkey|App Key would be generated and maintained by the APIGateway team. All products which want to consume APIGateway must register themselves. As a part of that process, a set of 2 keys would be generated and shared with the product. App key is one of those keys and this needs to be passed along in each post request to the APIGateway. Must be used in lower case.|
|accesstoken|Access Token is an artifact which is generated by Identity Service on successful login of an end user. This is also referred to as OAuth.AccessToken|
|uuid|UUID is an artifict which is unique for each consumer\end user. This is returned by the Identity service as one of the claims on successful logins|
|timestamp|Represents in epoch format (UTC) when the request had originated.|
|nonce|Nonce represents a random guid. Must be used in lower case|
|signature|# Signature represents an unique text which is generated following OAuth 1.0 standards. This must be generated using the private key which was shared during product registration. The signature must be passed along in the request. Please note that the private key <strong>MUST NOT </strong>be passed in the request object. Algorithm used is HMAC-SHA1. The data must be in the following format (in lowercase) - **AppKey + timeStamp + nonce + PrivateKey**.|
|X-TransactionID|A placeholder to pass a client identifier for downstream systems. A maximum of 16 characters would be read from this header. It is saved in all APIGatway logs and also gets returned on each post request.|


### Body Explained  
|field|explanation|
|-----|:----------:|
|service|This represents name of the service which needs to be invoked. The exact names of all services that are plugged into the APIGateway at any given point can be found in the service metadata - "\Metadata\[Value\name]"*|
|operation|This represents name of the api endpoint which needs to be invoked. The exact names of all operations that are plugged into the APIGateway at any given point can be found in the service metadata - "\Metadata\[Value\[operations\name]]"*|
|parameters|This represents an array of parameters represented in key-value format that are expected by the operation. The exact names of all operations parameters that are plugged into the APIGateway at any given point can be found in the service metadata - "\Metadata\[Value\[operations\[Parameters]]]"*|

## API Response
### Sample Successful Response with no data:
```
{"data":[],"status":true,"operationname":"clubcardservice_GetChristmasSaverSummary","errors":[],"receivedat":"1485499006","overallduration":"2663.7642","servicestats":"2352.2838","servedby":".15","clienttransactionid":"ac37186f-2e83-45"}
```
### Sample Successful Response with valid data:
```
{"data":{"CustomerID":"95","TitleEnglish":"Mrs","Name3":"Millsted","Name1":"","PointsBalanceQty":"355","Vouchers":3.5,"PrimaryCustomerFullName":"Mr M Millsted","ClubcardID":"634004024011836919","PrimaryCustomerName1":"Melvyn","PrimaryCustomerName2":"A","PrimaryCustomerName3":"Millsted","PrimaryClubcardID":"634004024011836927","AssociateCustName1":"JEAN                ","AssociateCustName2":"","AssociateCustName3":"Millsted","AssociateClubcardID":"634004024011836919","EmailAddress":null},"status":true,"operationname":"clubcardservice_GetCustomerAccountDetails","errors":[],"receivedat":"1494325361","overallduration":"31.25","servicestats":"0","servedby":".15","identifier":"2632f933-bdc3-420b-b750-8ecf5fd6dbb3","clienttransactionid":"501c36dc-9f71-44"}
  ```
### Sample Failed Response

```
{"data":null,"status":false,"operationname":"clubcardservices_GetCustomerAccountDetails","errors":[{"Key":"ERR-INTERNAL","Value":""}],"receivedat":"1485499006","overallduration":"75.1953","servicestats":null,"servedby":".15"}
```

### Explanation of the Response fields
|field|explanation|
|-----|:----------:|
|data|Represents a json representation of the data returned by the backend service endpoint|
|status|Represents a boolean flag that represents whether the request succeeded or not|
|operationname|Represents the name of the operation that was executed in the request|
|errors|Represents an array of error elements that have been encountered during request execution|
|receivedat|Represents epoch time when the request was received by the server|
|overallduration|Represents total time taken by web server to serve the request in milliseconds|
|servicestats|Represents time taken to make the backend service call in milliseconds|
|servedby|Represents last octet of the web server that had served the request|
|clienttransactionid|The same transaction ID which was passed in the Request header X-TransactionID. This is optional and will be blank if nothing gets sent across in the request header|

## APIGateway Metadata
```
<BaseURL>/mca
<BaseURL>/mca/apigateway
<BaseURL>/mca?apikey=<appkey>
<BaseURL>/apigateway?apikey=<appkey>
<BaseURL>/mca/<appkey>
<BaseURL>/<appkey>
```

# Appendix
* *[ ] -> Represents an element of an array
* **AdminContacts - yh75, zu21
* #OAuth 1.0 -> Please refer https://oauth1.wp-api.org/docs/basics/Signing.html for more details.
